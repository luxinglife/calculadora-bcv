name: Actualizar tasas BCV/USDT

on:
  schedule:
    # Se ejecuta cada hora (puedes cambiarlo, por ejemplo cada 30 minutos: '*/30 * * * *')
    - cron: '0 * * * *'
  workflow_dispatch:  # Permite ejecutarlo manualmente

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para hacer commit del archivo

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Obtener tasa oficial (BCV)
        run: |
          curl -s https://dolarapi.com/v1/dolares/oficial > oficial.json

      - name: Obtener tasa paralelo (referencia USDT)
        run: |
          curl -s https://dolarapi.com/v1/dolares/paralelo > paralelo.json

      - name: Extraer y guardar tasas
        run: |
          python3 -c "
          import json
          import sys

          try:
              # Leer tasa oficial
              with open('oficial.json') as f:
                  oficial_data = json.load(f)
              tasa_bcv = oficial_data.get('promedio') or oficial_data.get('venta')
              if not tasa_bcv:
                  print('Error: No se pudo obtener tasa BCV')
                  sys.exit(1)

              # Leer tasa paralelo (USDT)
              with open('paralelo.json') as f:
                  paralelo_data = json.load(f)
              tasa_usdt = paralelo_data.get('promedio') or paralelo_data.get('venta')
              if not tasa_usdt:
                  # Si no hay paralelo, estimar un 10% m√°s que la oficial
                  tasa_usdt = tasa_bcv * 1.1

              # Crear objeto con las tasas
              resultado = {
                  'bcv': round(float(tasa_bcv), 2),
                  'usdt': round(float(tasa_usdt), 2)
              }

              # Guardar en archivo
              with open('tasas.json', 'w') as f:
                  json.dump(resultado, f, indent=2)

              print('Tasas actualizadas correctamente')
          except Exception as e:
              print(f'Error: {e}')
              sys.exit(1)
          "

      - name: Hacer commit del archivo actualizado
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add tasas.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Actualizar tasas [skip ci]"
          git push
