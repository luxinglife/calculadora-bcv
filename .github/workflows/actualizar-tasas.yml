name: Actualizar tasas BCV/USDT

on:
  schedule:
    # Se ejecuta cada hora (puedes cambiarlo)
    - cron: '0 * * * *'
  workflow_dispatch:  # Permite ejecutarlo manualmente

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para hacer commit

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Obtener y guardar tasas
        run: |
          python3 -c "
import json
import urllib.request
import sys

def fetch_json(url):
    try:
        with urllib.request.urlopen(url, timeout=5) as response:
            return json.loads(response.read().decode())
    except Exception as e:
        print(f'Error al obtener {url}: {e}')
        return None

# Intentar obtener tasa oficial (BCV)
oficial_data = fetch_json('https://dolarapi.com/v1/dolares/oficial')
if oficial_data:
    tasa_bcv = oficial_data.get('promedio') or oficial_data.get('venta')
else:
    tasa_bcv = None

# Intentar obtener tasa paralelo (referencia para USDT)
paralelo_data = fetch_json('https://dolarapi.com/v1/dolares/paralelo')
if paralelo_data:
    tasa_usdt = paralelo_data.get('promedio') or paralelo_data.get('venta')
else:
    tasa_usdt = None

# Si algo falla, usar valores por defecto (pero no fallamos el workflow)
if tasa_bcv is None:
    print('⚠️ Usando valor por defecto para BCV: 36.00')
    tasa_bcv = 36.0
if tasa_usdt is None:
    print('⚠️ Estimando USDT como BCV * 1.1')
    tasa_usdt = tasa_bcv * 1.1

resultado = {
    'bcv': round(float(tasa_bcv), 2),
    'usdt': round(float(tasa_usdt), 2)
}

print('✅ Tasas obtenidas:', resultado)

# Guardar en archivo
with open('tasas.json', 'w') as f:
    json.dump(resultado, f, indent=2)
          "

      - name: Mostrar tasas generadas (para depuración)
        run: cat tasas.json

      - name: Hacer commit del archivo actualizado
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add tasas.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Actualizar tasas [skip ci]" && git push)
